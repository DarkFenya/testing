package main

import (
	"regexp"
	"sort"
	"strings"
)

// Структура для хранения информации о типе проблемы
type ProblemType struct {
	Name     string
	Triggers []string
	Patterns []*regexp.Regexp // Скомпилированные регулярные выражения
}

// Global map for problem types
var problemTypes = make(map[string]ProblemType)

// AdvancedTriggers добавляет расширенные триггеры к основным
func init() {
	// Инициализируем problemTypes если еще не инициализирована
	initializeProblemTypes()

	// Добавляем расширенные триггеры для каждого типа
	addAdvancedTriggers()

	// Компилируем регулярные выражения
	compilePatterns()
}

// initializeProblemTypes инициализирует базовые триггеры
func initializeProblemTypes() {
	if len(problemTypes) > 0 {
		return
	}

	problemTypes = map[string]ProblemType{
		"type1": {
			Name: "Явные призывы оператора поддержки",
			Triggers: []string{
				// Прямые обращения к оператору
				"оператор", "оператор", "операторск", "оператору", "операторо",
				"сотрудник", "сотруд", "сотруднич", "сотрудничеств",
				"менеджер", "менедж", "менедже", "менеджмен",
				"специалист", "спец", "специалис", "специалист",
				"консультант", "консульт", "консультац", "консультир",
				"служба поддержки", "служб поддерж", "служб подд", "служб подде",
				"техподдержка", "техподдерж", "техподд", "техподде",
				"поддержка", "поддерж", "поддержива", "поддержу",
				"помощь", "помощ", "помога", "помогающ",

				// Глаголы призыва
				"позов", "позови", "позвать", "позовете",
				"вызови", "вызыва", "вызов", "вызван",
				"приглас", "пригласи", "приглашен", "приглаша",
				"соедин", "соедини", "соединя", "соединен",
				"переда", "передай", "передач", "передава",
				"переключ", "переключи", "переключен", "переключа",
				"дай", "дайте", "дать", "давай", "давали",
				"предостав", "предоставь", "предостави", "предоставлен",
				"организу", "организ", "организова", "организац",
				"назнач", "назначи", "назначен", "назнача",
				"прикрепи", "прикреп", "прикреплен", "прикрепля",
				"закреп", "закрепи", "закреплен", "закрепля",
				"делегир", "делеги", "делегирован", "делегиру",
				"перенаправ", "перенаправи", "перенаправлен", "перенаправля",

				// Формы обращений
				"нужен", "нужна", "нужно", "нужны", "нужда",
				"требу", "требуй", "требую", "требует", "требова",
				"хочет", "хочу", "хотел", "хотела", "хотеть",
				"хотелось бы", "хотелос", "хотелось",
				"может", "мож", "можете", "мог", "могла",
				"пожалуйста", "пожалуйст", "пожал", "пожалуй",
				"прошу", "проси", "просит", "просил", "просила",
				"обрат", "обрати", "обраща", "обращен",

				// Категории специалистов
				"финансов", "финанс", "финансист", "финансир",
				"бухгалтер", "бухгалт", "бухгалтерск", "бухучет",
				"юридическ", "юрид", "юрист", "юриспруденц",
				"техническ", "тех", "техн", "техник", "технологи",
				"администратор", "админ", "администр", "администрац",
				"руководитель", "руковод", "руководящ", "руководств",
				"директор", "дирек", "дирекци", "директорск",
				"начальник", "началь", "начальств", "начальнич",
				"управляющ", "управля", "управл", "управлен",
				"ответственн", "ответствен", "ответств", "ответ",
				"куратор", "курир", "куриру", "курирован",
				"типлид", "лид", "лидер", "лидерств",
				"менеджер проект", "менеджер проект", "менедж проект", "менедж проект",
				"ключев", "ключев", "ключевой", "ключевик",

				// Отделы и службы
				"отдел", "отделен", "отдельно", "отделу",
				"служб", "служеб", "служебн", "службен",
				"департамент", "департа", "департамен",
				"подразделен", "подраздел", "подразделя",
				"центр", "центр", "центров", "центровой",
				"офис", "офис", "офисн", "офисир",

				// Общие фразы призыва
				"мне нужна помощь", "нужна помощь", "помогите",
				"вызывайте", "пришлите", "направьте", "подключите",
				"дайте возможность", "предоставьте доступ",
				"требую разговора", "хочу поговорить", "желаю обсудить",
				"нужен человек", "нужен живой человек", "живого человека",
				"настоящий сотрудник", "реальный специалист",
				"компетентный сотрудник", "квалифицированный специалист",
				"ваш специалист", "ваш сотрудник", "ваш менеджер",
				"представитель компании", "сотрудник компании",
			},
		},
		"type2": {
			Name: "Нецензурные выражения и оскорбления",
			Triggers: []string{
				// Нецензурные выражения (цензурированные)
				"бл", "бл*", "бл*дь", "бл*я", "бл*ть", "бл*д", "бл*дство",
				"х*й", "х*ер", "х*р", "х*рн", "х*рня", "х*рен",
				"п*зд", "п*здец", "п*здет", "п*зди", "п*зде",
				"ё*", "ё*ан", "ё*б", "ё*бал", "ё*бат", "ё*бическ",
				"е*", "е*ан", "е*б", "е*бал", "е*бат", "е*бическ",
				"муд*", "муд*к", "муд*ец", "муд*ня", "муд*о",
				"г*вн", "г*вно", "г*венный", "г*вня",
				"ж*п", "ж*па", "ж*пный", "ж*пень",
				"с*к", "с*ка", "с*кин", "с*чий",
				"д*лб", "д*лба", "д*лби", "д*лбо",
				"убл*д", "убл*док", "убл*доч", "убл*дск",
				"п*др", "п*дра", "п*дри", "п*дро",
				"шл*х", "шл*ха", "шл*хи", "шл*хо",

				// Оскорбления личные
				"дурак", "дур", "дура", "дури", "дуро",
				"идиот", "идио", "идиотск", "идиотство",
				"дебил", "деби", "дебильн", "дебильно",
				"кретин", "кретин", "кретинск", "кретинизм",
				"тупица", "тупи", "тупиц", "тупой",
				"тупой", "туп", "тупо", "туповат",
				"олух", "олу", "олухов", "олуховый",
				"болван", "болв", "болванов", "болвановый",
				"простофиля", "простофил", "простофильн", "простофильный",
				"раззява", "раззи", "раззявин", "раззявинный",
				"растяпа", "растя", "растяпин", "растяпинный",
				"шляпа", "шля", "шляпник", "шляпный",
				"бездарь", "бездар", "бездарн", "бездарно",
				"ничтожество", "ничтож", "ничтожн", "ничтожно",
				"недоумок", "недоум", "недоумен", "недоумно",

				// Оскорбления профессиональные
				"некомпетентный", "некомпетент", "некомпетентн", "некомпетентно",
				"непрофессиональный", "непрофессионал", "непрофессиональн", "непрофессионально",
				"неграмотный", "неграмот", "неграмотн", "неграмотно",
				"безответственный", "безответствен", "безответственн", "безответственно",
				"халатность", "халат", "халатно", "халатно",
				"разгильдяй", "разгильд", "разгильдяйств", "разгильдяйство",
				"бездельник", "бездель", "бездельнич", "бездельничество",
				"лентяй", "лент", "лентяйств", "лентяйство",

				// Оскорбления моральные
				"подлец", "подл", "подлень", "подло",
				"негодяй", "негод", "негодяйск", "негодяйство",
				"подонок", "подон", "подонков", "подонковый",
				"мерзавец", "мерзав", "мерзавч", "мерзавск",
				"сволочь", "сволоч", "сволочн", "сволочью",
				"стерва", "стерв", "стервч", "стервск",
				"тварь", "твар", "тварин", "тварьск",
				"падла", "падл", "падлюк", "падлюч",
				"гад", "гады", "гадин", "гадск", "гадост",
				"скотина", "скотин", "скот", "скоть", "скотиня",
				"ублюдок", "ублюд", "ублюдоч", "ублюдск",
				"мразь", "мраз", "мразот", "мразотн",
				"отброс", "отброс", "отбросов", "отбросовый",
				"отродье", "отрод", "отродьин", "отродьинск",
				"выродок", "вырод", "выродков", "выродковый",

				// Агрессивные сравнения
				"животное", "живот", "животн", "животно",
				"зверь", "звер", "зверск", "зверство",
				"скотина", "скотин", "скот", "скотов",
				"тварь", "твар", "тварин", "тварьск",
				"паразит", "парази", "паразитн", "паразитир",
				"кровопийца", "кровопий", "кровопийств", "кровопийство",
				"хищник", "хищн", "хищнич", "хищничество",
				"вор", "воры", "воровск", "воровство",
				"мошенник", "мошен", "мошенническ", "мошенничество",
				"жулик", "жул", "жуликов", "жуликовый",
				"аферист", "афери", "аферистск", "аферистство",
				"обманщик", "обманщ", "обманщиц", "обманщицк",
				"кидала", "кида", "кидалов", "кидалово",
				"разводила", "разводи", "разводилов", "разводилово",

				// Общие оскорбительные фразы
				"сумасшедший", "сумасшедш", "сумасшедш", "сумасшедше",
				"псих", "псих", "психов", "психовый",
				"больной", "больн", "больно", "больного",
				"ненормальный", "ненормаль", "ненормальн", "ненормально",
				"ущербный", "ущерб", "ущербн", "ущербно",
				"неполноценный", "неполноцен", "неполноценн", "неполноценно",
				"отсталый", "отстал", "отстало", "отсталого",
				"придурок", "придур", "придурков", "придурковый",
				"дегенерат", "дегенер", "дегенератн", "дегенеративно",
				"имбецил", "имбец", "имбецилов", "имбециловый",

				// Эмоциональные оскорбления
				"наглец", "нагл", "нагло", "наглого",
				"хам", "хам", "хамов", "хамовый",
				"грубиян", "груби", "грубиянск", "грубиянство",
				"нахал", "нахал", "нахалов", "нахаловый",
				"беспардонный", "беспардон", "беспардонн", "беспардонно",
				"бессовестный", "бессовест", "бессовестн", "бессовестно",
				"бесстыжий", "бесстыж", "бесстыже", "бесстыжего",
				"бесстыдник", "бесстыд", "бесстыднич", "бесстыдничество",
				"нахальный", "нахаль", "нахальн", "нахально",
				"дерзкий", "дерз", "дерзко", "дерзкого",
				"наглый", "нагл", "нагло", "наглого",

				// Знаки препинания (эмоциональные)
				"!!!", "!!!!", "!!!!!",
				"???", "????", "?????",
				"!!??", "??!!", "!?!",
			},
		},
		"type3": {
			Name: "Угрозы судом и юридические угрозы",
			Triggers: []string{
				// Судебные органы
				"суд", "суд", "судов", "судеб", "судебн", "судейск",
				"мировой суд", "миров суд", "миров суд",
				"районный суд", "район суд", "район суд",
				"городской суд", "городск суд", "городск суд",
				"областной суд", "областн суд", "областн суд",
				"верховный суд", "верховн суд", "верховн суд",
				"арбитражный суд", "арбитраж суд", "арбитраж суд",
				"третейский суд", "третейск суд", "третейск суд",
				"конституционный суд", "конституцион суд", "конституцион суд",

				// Прокуратура
				"прокуратур", "прокур", "прокуратур", "прокурор",
				"генпрокуратура", "генпрокур", "генпрокуратур",
				"прокурор", "прокур", "прокуроров", "прокурорск",
				"прокурорская", "прокурорск", "прокурорскую",

				// Роспотребнадзор
				"роспотребнадзор", "роспотреб", "роспотребнадз",
				"рспн", "рспн", "рспнов", "рспновый",

				// ФАС
				"фас", "фас", "фасов", "фасовый",
				"федеральная антимонопольная служба", "антимонопольн", "антимонопол",
				"антимонопольная служба", "антимонопол служб",

				// Налоговая
				"налоговая", "налог", "налогов", "налоговый",
				"инспекция", "инспек", "инспекц", "инспекцион",
				"фнс", "фнс", "фнсов", "фнсовый",
				"федеральная налоговая служба", "федеральн налогов",

				// Правоохранительные органы
				"полиция", "полиц", "полицей", "полицейск",
				"мвд", "мвд", "мвдов", "мвдовый",
				"следственный комитет", "следствен", "следствен",
				"ск рф", "ск", "сков", "сковый",
				"фсб", "фсб", "фсбов", "фсбовый",

				// Иски и заявления
				"иск", "иск", "исков", "исковый",
				"исковое заявление", "исков заявлен", "исков заявл",
				"заявление в суд", "заявлен в суд", "заявл в суд",
				"исковое требование", "исков требова", "исков требов",
				"претензия", "претенз", "претензион", "претензионн",
				"претензионное письмо", "претензион писем", "претензион письм",
				"жалоба", "жалоб", "жалобн", "жалобно",
				"официальная жалоба", "официальн жалоб", "официальн жалоб",
				"коллективный иск", "коллективн иск", "коллективн иск",
				"групповой иск", "группов иск", "группов иск",
				"массовый иск", "массов иск", "массов иск",

				// Юридические лица
				"адвокат", "адвока", "адвокатов", "адвокатск",
				"юрист", "юрист", "юристов", "юристск",
				"юридическая компания", "юридическ компани", "юридическ компани",
				"юридическая фирма", "юридическ фирм", "юридическ фирм",
				"юрисконсульт", "юрисконсуль", "юрисконсультск", "юрисконсультир",
				"нотариус", "нотар", "нотариусов", "нотариальн",
				"арбитражный управляющий", "арбитраж управля", "арбитраж управля",
				"правозащитник", "правозащит", "правозащитнич", "правозащитничество",

				// Процессуальные действия
				"подать в суд", "пода в суд", "подам в суд",
				"обратиться в суд", "обрат в суд", "обращусь в суд",
				"подать иск", "пода иск", "подам иск",
				"написать заявление", "напиш заявлен", "напишу заявлен",
				"составить иск", "состав иск", "составлю иск",
				"подать жалобу", "пода жалоб", "подам жалоб",
				"подать апелляцию", "пода апелляц", "подам апелляц",
				"подать кассацию", "пода кассац", "подам кассац",
				"обжаловать", "обжалова", "обжалую", "обжалует",
				"оспаривать", "оспарива", "оспорю", "оспаривает",

				// Судебные процессы
				"судебный процесс", "судебн процесс", "судебн процесс",
				"судебное разбирательство", "судебн разбирательств", "судебн разбирательств",
				"судебное заседание", "судебн заседан", "судебн заседан",
				"судебное слушание", "судебн слушан", "судебн слушан",
				"судебное решение", "судебн решен", "судебн решен",
				"судебный приказ", "судебн приказ", "судебн приказ",
				"судебный исполнитель", "судебн исполнит", "судебн исполнит",
				"судебный пристав", "судебн пристав", "судебн пристав",
				"исполнительное производство", "исполнительн производств", "исполнительн производств",

				// Юридические последствия
				"привлечь к ответственности", "привлеч к ответствен", "привлеку к ответствен",
				"привлечь к субсидиарной ответственности", "привлеч к субсидиар", "привлеку к субсидиар",
				"привлечь к административной ответственности", "привлеч к административ", "привлеку к административ",
				"привлечь к уголовной ответственности", "привлеч к уголовн", "привлеку к уголовн",
				"привлечь к материальной ответственности", "привлеч к материальн", "привлеку к материальн",
				"взыскать", "взыска", "взыщу", "взыщет",
				"взыскать убытки", "взыска убытк", "взыщу убытк",
				"взыскать неустойку", "взыска неустойк", "взыщу неустойк",
				"взыскать штраф", "взыска штраф", "взыщу штраф",
				"взыскать компенсацию", "взыска компенсац", "взыщу компенсац",
				"взыскать моральный вред", "взыска моральн вред", "взыщу моральн вред",

				// Угрозы
				"привлеку", "привлеч", "привлеку", "привлечет",
				"подам", "пода", "подам", "подаст",
				"обращусь", "обращ", "обращусь", "обратится",
				"напишу", "напиш", "напишу", "напишет",
				"составлю", "состав", "составлю", "составит",
				"обжалую", "обжал", "обжалую", "обжалует",
				"оспорю", "оспор", "оспорю", "оспорит",
				"взыщу", "взыщ", "взыщу", "взыщет",
				"заставлю", "застав", "заставлю", "заставит",
				"засуду", "засуд", "засужу", "засудит",
				"разорю", "разор", "разорю", "разорит",
				"уничтожу", "уничтож", "уничтожу", "уничтожит",

				// Юридические термины
				"незаконный", "незакон", "незаконн", "незаконно",
				"неправомерный", "неправомер", "неправомерн", "неправомерно",
				"противозаконный", "противозакон", "противозаконн", "противозаконно",
				"противоправный", "противоправ", "противоправн", "противоправно",
				"нелегальный", "нелегал", "нелегальн", "нелегально",
				"произвол", "произвол", "произвольн", "произвольно",
				"беззаконие", "беззакон", "беззаконн", "беззаконно",
				"нарушение прав", "нарушен прав", "наруш прав",
				"нарушение закона", "нарушен закон", "наруш закон",
				"нарушение договора", "нарушен договор", "наруш договор",
				"нарушение условий", "нарушен услови", "наруш услови",
				"нарушение обязательств", "нарушен обязательств", "наруш обязательств",
				"неисполнение обязательств", "неисполнен обязательств", "неисполн обязательств",
				"ненадлежащее исполнение", "ненадлежащ исполнен", "ненадлежащ исполн",
				"ненадлежащее качество", "ненадлежащ качеств", "ненадлежащ качеств",

				// Материальные требования
				"компенсация", "компенсац", "компенсацион", "компенсир",
				"возмещение", "возмещен", "возместит", "возмеща",
				"возмещение убытков", "возмещен убытк", "возмест убытк",
				"возмещение вреда", "возмещен вред", "возмест вред",
				"возмещение морального вреда", "возмещен моральн вред", "возмест моральн вред",
				"возмещение материального ущерба", "возмещен материальн ущерб", "возмест материальн ущерб",
				"штраф", "штраф", "штрафн", "штрафной",
				"неустойка", "неустойк", "неустоечн", "неустоечно",
				"пеня", "пен", "пень", "пенной",
				"санкция", "санкц", "санкцион", "санкционир",
				"издержки", "издерж", "издержек", "издержечн",
				"судебные издержки", "судебн издерж", "судебн издерж",
				"расходы", "расход", "расходов", "расходный",
				"судебные расходы", "судебн расход", "судебн расход",

				// Документы
				"официальный ответ", "официальн ответ", "официальн ответ",
				"письменный ответ", "письменн ответ", "письменн ответ",
				"ответ на претензию", "ответ на претенз", "ответ на претенз",
				"юридически значимый документ", "юридическ значим документ", "юридическ значим документ",
				"документ с печатью", "документ с печат", "документ с печат",
				"документ с подписью", "документ с подпис", "документ с подпис",
				"заверенная копия", "заверен копи", "заверен копи",
				"нотариально заверенная копия", "нотариальн заверен копи", "нотариальн заверен копи",
				"заверенный перевод", "заверен перевод", "заверен перевод",

				// Сроки
				"срок исковой давности", "срок исков давност", "срок исков давност",
				"претензионный порядок", "претензион поряд", "претензион поряд",
				"досудебное урегулирование", "досудебн урегулирован", "досудебн урегулирован",
				"досудебная претензия", "досудебн претенз", "досудебн претенз",
				"срок ответа на претензию", "срок ответ на претенз", "срок ответ на претенз",
				"установленный срок", "установлен срок", "установлен срок",
				"законный срок", "законн срок", "законн срок",
				"разумный срок", "разумн срок", "разумн срок",

				// Дополнительные угрозы
				"привлечение полиции", "привлечен полиц", "привлеч полиц",
				"заявление в полицию", "заявлен в полиц", "заявл в полиц",
				"вызов полиции", "вызов полиц", "вызов полиц",
				"обращение в правоохранительные органы", "обращен в правоохранит орган", "обращ в правоохранит орган",
				"обращение в следственный комитет", "обращен в следствен комитет", "обращ в следствен комитет",
				"обращение в фсб", "обращен в фсб", "обращ в фсб",
				"проверка", "провер", "проверк", "проверочн",
				"внеплановая проверка", "внеплан провер", "внеплан провер",
				"внезапная проверка", "внезапн провер", "внезапн провер",
				"налоговая проверка", "налогов провер", "налогов провер",
				"трудовая инспекция", "трудов инспек", "трудов инспек",
				"санэпидемстанция", "санэпидем", "санэпидемстанц",
				"роскомнадзор", "роскомнадз", "роскомнадзоров",
				"ростехнадзор", "ростехнадз", "ростехнадзоров",
				"рострудинспекция", "рострудинспек", "рострудинспекц",
			},
		},
	}
}

// addAdvancedTriggers добавляет расширенные триггеры
func addAdvancedTriggers() {
	// Дополнительные триггеры для type1 (призывы оператора)
	operatorTriggers := []string{
		"человек", "челове", "человек", "человеч",
		"живой", "жив", "живо", "живого",
		"настоящий", "настоящ", "настояще", "настоящего",
		"реальный", "реальн", "реально", "реального",
		"компетентный", "компетент", "компетентн", "компетентно",
		"квалифицированный", "квалифицирован", "квалифицированн", "квалифицированно",
		"грамотный", "грамот", "грамотн", "грамотно",
		"опытный", "опытн", "опытно", "опытного",
		"профессиональный", "профессионал", "профессиональн", "профессионально",
		"ответственный", "ответствен", "ответственн", "ответственно",
		"вменяемый", "вменя", "вменяем", "вменяемо",
		"адекватный", "адекват", "адекватн", "адекватно",
		"разбирающийся", "разбирающ", "разбирается", "разбирающемуся",
		"понимающий", "понимающ", "понимает", "понимающему",
	}

	if val, ok := problemTypes["type1"]; ok {
		val.Triggers = append(val.Triggers, operatorTriggers...)
		problemTypes["type1"] = val
	}

	// Дополнительные триггеры для type2 (оскорбления)
	insultTriggers := []string{
		"неадекват", "неадекват", "неадекватн", "неадекватно",
		"психопат", "психопат", "психопатск", "психопатическ",
		"шизофреник", "шизофрени", "шизофреников", "шизофреническ",
		"маньяк", "манья", "маньяков", "маньяческ",
		"садист", "сади", "садистов", "садистическ",
		"изверг", "извер", "извергов", "извержеск",
		"чудовище", "чудов", "чудовищ", "чудовищн",
		"монстр", "монстр", "монстров", "монстрическ",
		"урод", "урод", "уродов", "уродск",
		"калека", "калек", "калеков", "калечн",
		"инвалид", "инвали", "инвалидов", "инвалидн",
		"кретин", "кретин", "кретинов", "кретинизм",
		"дегенерат", "дегенер", "дегенератов", "дегенеративн",
		"имбецил", "имбец", "имбецилов", "имбецильн",
		"даун", "даун", "даунов", "даунск",
		"даунист", "дауни", "даунистов", "даунистическ",
		"олигофрен", "олигофр", "олигофренов", "олигофреническ",
		"слабоумный", "слабоум", "слабоумн", "слабоумно",
		"умственно отсталый", "умственн отстал", "умственн отстал",
		"психически больной", "психическ больн", "психическ больн",
	}

	if val, ok := problemTypes["type2"]; ok {
		val.Triggers = append(val.Triggers, insultTriggers...)
		problemTypes["type2"] = val
	}

	// Дополнительные триггеры для type3 (угрозы судом)
	legalThreatTriggers := []string{
		"судья", "судь", "судей", "судейск",
		"мировой судья", "миров судь", "миров судь",
		"федеральный судья", "федеральн судь", "федеральн судь",
		"арбитражный судья", "арбитраж судь", "арбитраж судь",
		"конституционный судья", "конституцион судь", "конституцион судь",
		"коллегия судей", "коллег судей", "коллег судей",
		"председатель суда", "председат суд", "председат суд",
		"заместитель председателя суда", "заместит председат суд", "заместит председат суд",
		"суд присяжных", "суд присяжн", "суд присяжн",
		"коллегия присяжных", "коллег присяжн", "коллег присяжн",
		"присяжный заседатель", "присяжн заседат", "присяжн заседат",
		"народный заседатель", "народн заседат", "народн заседат",
		"арбитр", "арбитр", "арбитров", "арбитражн",
		"третейский судья", "третейск судь", "третейск судь",
		"международный суд", "международн суд", "международн суд",
		"международный арбитраж", "международн арбитраж", "международн арбитраж",
		"гаагский суд", "гаагск суд", "гаагск суд",
		"европейский суд", "европейск суд", "европейск суд",
		"европейский суд по правам человека", "европейск суд по прав человек", "европейск суд по прав человек",
		"страсбургский суд", "страсбургск суд", "страсбургск суд",
		"оон", "оон", "оонов", "ооновск",
		"организация объединенных наций", "организац объединен нац", "организац объединен нац",
		"юнеско", "юнеско", "юнесков", "юнесковск",
		"вто", "вто", "втов", "втовск",
		"всемирная торговая организация", "всемирн торгов организац", "всемирн торгов организац",
		"международный валютный фонд", "международн валютн фонд", "международн валютн фонд",
		"всемирный банк", "всемирн банк", "всемирн банк",
		"международный арбитражный суд", "международн арбитраж суд", "международн арбитраж суд",
		"международная торговая палата", "международн торгов палат", "международн торгов палат",
		"лондонский международный арбитражный суд", "лондонск международн арбитраж суд", "лондонск международн арбитраж суд",
		"сингапурский международный арбитражный центр", "сингапурск международн арбитраж центр", "сингапурск международн арбитраж центр",
		"гонконгский международный арбитражный центр", "гонконгск международн арбитраж центр", "гонконгск международн арбитраж центр",
		"парижский международный арбитражный суд", "парижск международн арбитраж суд", "парижск международн арбитраж суд",
	}

	if val, ok := problemTypes["type3"]; ok {
		val.Triggers = append(val.Triggers, legalThreatTriggers...)
		problemTypes["type3"] = val
	}
}

// compilePatterns компилирует регулярные выражения для каждого триггера
func compilePatterns() {
	for typeKey, typeInfo := range problemTypes {
		var patterns []*regexp.Regexp
		uniquePatterns := make(map[string]bool)

		for _, trigger := range typeInfo.Triggers {
			// Для нецензурных выражений создаем специальные паттерны
			if typeKey == "type2" {
				// Для нецензурных слов с звездочками или другими заменами
				if strings.Contains(trigger, "*") {
					// Заменяем звездочки на символьные классы
					patternStr := strings.ReplaceAll(trigger, "*", "[а-яa-z]*")
					patternStr = `(?i)\b` + patternStr + `\b`
					if !uniquePatterns[patternStr] {
						uniquePatterns[patternStr] = true
						if pattern, err := regexp.Compile(patternStr); err == nil {
							patterns = append(patterns, pattern)
						}
					}
					continue
				}
			}

			// Стандартный паттерн для поиска слова целиком
			patternStr := `(?i)\b` + regexp.QuoteMeta(trigger) + `\b`

			// Для коротких триггеров (1-3 символа) делаем менее строгий поиск
			if len(trigger) <= 3 {
				patternStr = `(?i)` + regexp.QuoteMeta(trigger)
			}

			// Для знаков препинания в type2
			if typeKey == "type2" && len(trigger) == 1 && strings.ContainsAny(trigger, "!?.") {
				patternStr = `(?i)[` + regexp.QuoteMeta(trigger) + `]{2,}`
			}

			if !uniquePatterns[patternStr] {
				uniquePatterns[patternStr] = true
				if pattern, err := regexp.Compile(patternStr); err == nil {
					patterns = append(patterns, pattern)
				}
			}
		}

		// Сохраняем скомпилированные паттерны
		typeInfo.Patterns = patterns
		problemTypes[typeKey] = typeInfo
	}
}

// CleanTriggers удаляет дубликаты триггеров и сортирует их
func CleanTriggers() {
	for typeKey, typeInfo := range problemTypes {
		// Удаляем дубликаты
		uniqueTriggers := make(map[string]bool)
		var cleanedTriggers []string

		for _, trigger := range typeInfo.Triggers {
			normalized := strings.ToLower(strings.TrimSpace(trigger))
			if !uniqueTriggers[normalized] {
				uniqueTriggers[normalized] = true
				cleanedTriggers = append(cleanedTriggers, trigger)
			}
		}

		// Сортируем триггеры
		sort.Strings(cleanedTriggers)

		// Обновляем структуру
		problemTypes[typeKey] = ProblemType{
			Name:     typeInfo.Name,
			Triggers: cleanedTriggers,
			Patterns: typeInfo.Patterns,
		}
	}
}

// FindPatternMatches ищет совпадения с помощью скомпилированных паттернов
func FindPatternMatches(text string, typeKey string) []string {
	var matches []string
	if typeInfo, ok := problemTypes[typeKey]; ok {
		for _, pattern := range typeInfo.Patterns {
			if pattern.MatchString(text) {
				// Находим все совпадения
				allMatches := pattern.FindAllString(text, -1)
				for _, match := range allMatches {
					matches = append(matches, match)
				}
			}
		}
	}
	return matches
}

// GetTriggers возвращает триггеры для указанного типа
func GetTriggers(typeKey string) []string {
	if typeInfo, ok := problemTypes[typeKey]; ok {
		return typeInfo.Triggers
	}
	return []string{}
}

// GetAllTriggers возвращает все триггеры
func GetAllTriggers() map[string][]string {
	result := make(map[string][]string)
	for typeKey, typeInfo := range problemTypes {
		result[typeKey] = typeInfo.Triggers
	}
	return result
}
